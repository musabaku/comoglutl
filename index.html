<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Price Catalog (TL)</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- jsPDF and jsPDF-AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Custom Styles & Animations -->
    <style>
        :root {
            --header-bg: #cb8717;
            --primary-accent: #1a6c47;
            --tagline-color: #FFFFFF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }

        .header-custom-bg { background-color: var(--header-bg); }
        .tagline-custom-color { color: var(--tagline-color); }
        .price-accent-color { color: var(--primary-accent); }
        .brand-title-accent { background-color: var(--primary-accent); }
        
        .btn-primary {
            background-color: var(--primary-accent);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .brand-button-active {
            background-color: var(--primary-accent) !important;
            color: white !important;
        }

        /* Animation for product cards appearing */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .product-card-animate {
            opacity: 0; 
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Cart styles */
        #cart-container {
            transition: transform 0.3s ease-in-out;
        }
        .cart-hidden {
            transform: translateX(100%);
        }

        /* Scroll to top button visibility */
        #scroll-to-top-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- Header Section -->
    <header class="header-custom-bg shadow-lg sticky top-0 z-20">
        <div class="container mx-auto px-4 sm:px-6 py-3">
            <div class="flex justify-between items-center">
                <!-- Left Side: Main Logo and Title -->
                <div class="flex items-center gap-3 sm:gap-4">
                    <img src="https://i.ibb.co/7d57gNYf/Clean_Shot-14-08-2025-at-2-11-43-2x.png" alt="Company Logo" class="h-10 sm:h-12 w-auto flex-shrink-0">
                    <div>
                        <h1 class="text-lg sm:text-xl md:text-3xl font-extrabold text-white tracking-tight">
                            Digital Price Catalog
                        </h1>
                         <p class="tagline-custom-color text-xs hidden sm:block">Leading Turkish FMCG Distributors & Exporters</p>
                    </div>
                </div>
                
                <!-- Right Side: Partner Logos and Cart -->
                <div class="flex items-center flex-shrink-0 gap-2 sm:gap-4">
                    <div class="flex flex-col sm:flex-row gap-1 sm:gap-2 items-center">
                        <img src="https://i.ibb.co/vCG3hRL8/onlinefmcglogo.png" alt="Partner Logo 1" class="h-6 sm:h-10 w-auto object-contain">
                        <img src="https://i.ibb.co/ccB5q02K/cropped-Whats-App-Image-2025-07-28-at-9-57-22-PM.jpg" alt="Partner Logo 2" class="h-6 sm:h-10 w-auto object-contain">
                    </div>
                    <button id="view-cart-button" class="relative btn-primary p-2 rounded-lg shadow transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span id="cart-item-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                    </button>
                </div>
            </div>
            <!-- Tagline for mobile view -->
            <p class="tagline-custom-color text-xs sm:hidden mt-1">Leading Turkish FMCG Distributors & Exporters</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8 relative">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Products Section -->
            <div class="w-full">
                <!-- Brand Navigation Buttons -->
                <nav id="brand-nav" class="bg-white p-4 shadow-md mb-10 rounded-xl md:sticky top-24 z-10 backdrop-blur-sm bg-white/70">
                    <div id="brand-nav-buttons" class="flex flex-wrap justify-center gap-3">
                        <div class="text-center p-4">Loading Brands...</div>
                    </div>
                </nav>

                <!-- Product Display Section -->
                <section id="product-section">
                    <div id="brand-title-container" class="flex items-center mb-8 gap-4">
                        <span class="w-3 h-10 brand-title-accent rounded-full"></span>
                        <h2 id="brand-title" class="text-3xl font-bold text-slate-800">
                            Loading...
                        </h2>
                    </div>
                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        <!-- Product cards will be dynamically injected here -->
                    </div>
                </section>
            </div>

            <!-- Shopping Cart Section -->
            <aside id="cart-container" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-50 p-6 flex flex-col cart-hidden">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">My Cart</h2>
                    <button id="close-cart-button" class="text-slate-500 hover:text-slate-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="cart-items" class="flex-grow overflow-y-auto">
                    <!-- Cart items will be injected here -->
                    <p class="text-slate-500 text-center mt-8">Your cart is empty.</p>
                </div>
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center font-bold text-lg mb-4">
                        <span>Total:</span>
                        <span id="cart-total">0.00 TL</span>
                    </div>
                    <div class="space-y-4 mb-4">
                        <div>
                            <label for="company-name" class="block text-sm font-medium text-slate-700 mb-1">Company Name *</label>
                            <input type="text" id="company-name" name="company-name" class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your company name" required>
                        </div>
                        <div>
                             <label for="phone-number" class="block text-sm font-medium text-slate-700 mb-1">Phone Number *</label>
                             <div class="flex">
                                <select id="country-code" class="border-slate-300 rounded-l-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="+90" selected>+90 (TR)</option>
                                    <option value="+1">+1 (US)</option>
                                    <option value="+44">+44 (UK)</option>
                                    <option value="+49">+49 (DE)</option>
                                    <option value="+971">+971 (AE)</option>
                                </select>
                                <input type="tel" id="phone-number" name="phone-number" class="w-full border-slate-300 rounded-r-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="555 123 4567" required>
                             </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <button id="submit-order-btn" class="w-full btn-primary py-2 px-4 rounded-lg transition disabled:opacity-50" disabled>Submit & Export Order</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" class="fixed bottom-6 right-6 z-50 h-12 w-12 rounded-full btn-primary shadow-lg flex items-center justify-center transition-all duration-300 opacity-0 transform translate-y-4 pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
    </button>

    <!-- Footer Section -->
    <footer class="text-center py-6 mt-12 bg-white border-t border-slate-200">
        <p class="text-slate-500 text-sm">&copy; 2025 Çomoğlu Gıda Price Catalog. All rights reserved.</p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-3 transition-all duration-300">
        Item added to cart!
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTemIQAjyMsEqPPUYaNMIn2rwrEbuqR7NrW9vey_mC1iZmIn7FZlOH7g3Co7bZG5B18BJy7Cjldvs53/pub?output=csv';

        const brandLogoMap = {
            "BEŞLER": "https://res.cloudinary.com/dnc3itu1c/image/upload/l1.jpg", "MASSIMO": "https://res.cloudinary.com/dnc3itu1c/image/upload/l2.jpg", "EDAY": "https://res.cloudinary.com/dnc3itu1c/image/upload/l3.jpg", "BENORGANIC": "https://res.cloudinary.com/dnc3itu1c/image/upload/l4.jpg", "UĞURLU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l5.jpg", "ÜNALPEYNIR": "https://res.cloudinary.com/dnc3itu1c/image/upload/l6.jpg", "ŞİFALIKÖY": "https://res.cloudinary.com/dnc3itu1c/image/upload/l7.jpg", "HOSANLI": "https://res.cloudinary.com/dnc3itu1c/image/upload/v1755239661/l8.jpg", "ORDU TARIM": "https://res.cloudinary.com/dnc3itu1c/image/upload/v1755239712/l9.jpg", "HAŞİROĞLU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l10.jpg", "TADA": "https://res.cloudinary.com/dnc3itu1c/image/upload/l11.jpg", "TAT": "https://res.cloudinary.com/dnc3itu1c/image/upload/l12.jpg", "TEK LEZET": "https://res.cloudinary.com/dnc3itu1c/image/upload/l13.jpg", "TAHSİLDAROĞLU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l14.jpg", "ERİŞ UN": "https://res.cloudinary.com/dnc3itu1c/image/upload/l15.jpg", "SOSERO": "https://res.cloudinary.com/dnc3itu1c/image/upload/l16.jpg", "YÖRE": "https://res.cloudinary.com/dnc3itu1c/image/upload/l17.jpg", "JUNGLE": "https://res.cloudinary.com/dnc3itu1c/image/upload/l18.jpg", "SMILE": "https://res.cloudinary.com/dnc3itu1c/image/upload/l19.jpg", "AYTAÇ": "https://res.cloudinary.com/dnc3itu1c/image/upload/l20.jpg", "OFÇAY": "https://res.cloudinary.com/dnc3itu1c/image/upload/l21.jpg", "EFOR": "https://res.cloudinary.com/dnc3itu1c/image/upload/l22.jpg", "GÜNDOĞDU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l23.jpg"
        };

        // --- DOM Elements ---
        const brandNavContainer = document.getElementById('brand-nav-buttons');
        const brandTitleContainer = document.getElementById('brand-title-container');
        const productGrid = document.getElementById('product-grid');
        const cartContainer = document.getElementById('cart-container');
        const viewCartButton = document.getElementById('view-cart-button');
        const closeCartButton = document.getElementById('close-cart-button');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartItemCountEl = document.getElementById('cart-item-count');
        const submitOrderBtn = document.getElementById('submit-order-btn');
        const toastEl = document.getElementById('toast');
        const companyNameInput = document.getElementById('company-name');
        const countryCodeInput = document.getElementById('country-code');
        const phoneNumberInput = document.getElementById('phone-number');
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');

        let catalogData = {};
        let orderedBrands = [];
        let cart = {}; // Local cart state
        let currentBrand = null; // To track the currently displayed brand
        
        // --- Firebase ---
        let db, auth, userId;
        let cartDocRef;
        let unsubscribeCart; // To detach listener on sign-out

        // Hardcoded Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjl2QFyRWoN_SjbRKTuhxp9ksgm-5MBTw", authDomain: "comogluimg.firebaseapp.com", projectId: "comogluimg", storageBucket: "comogluimg.appspot.com", messagingSenderId: "964383861519", appId: "1:964383861519:web:447d607e3c158df951ec7a", measurementId: "G-NK80JQBKXE"
        };
        const appId = 'digital-price-catalog-tl';


        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is not available."); return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        const cartPath = `/artifacts/${appId}/users/${userId}/cart/data`;
                        cartDocRef = doc(db, cartPath);
                        listenToCartChanges();
                    } else {
                        console.log("No user found, attempting anonymous sign-in...");
                        try { await signInAnonymously(auth); } catch (e) { console.error("Firebase anonymous sign-in failed:", e); }
                    }
                });
            } catch (error) { console.error("Firebase initialization failed:", error); }
        }
        
        /**
         * Listens for real-time updates to the user's cart in Firestore.
         */
        function listenToCartChanges() {
            if (unsubscribeCart) unsubscribeCart();
            if (!cartDocRef) return;
            unsubscribeCart = onSnapshot(cartDocRef, (doc) => {
                cart = doc.exists() ? doc.data().items || {} : {};
                renderCart();
                if (currentBrand) { displayProducts(currentBrand, false); } // Don't scroll on background refresh
            }, (error) => { console.error("Error listening to cart changes:", error); });
        }

        /**
         * Saves the entire cart object to Firestore.
         */
        async function saveCartToFirestore() {
            if (!cartDocRef) return;
            try { await setDoc(cartDocRef, { items: cart }); } catch (error) { console.error("Error saving cart to Firestore:", error); }
        }
        
        /**
         * Parses CSV text into a structured JavaScript object.
         */
        function parseCsvData(csvText) {
            const data = {};
            const seenBrands = new Set();
            const rows = csvText.trim().replace(/\r/g, '').split('\n').filter(row => row.trim() !== '');
            const headers = rows[0].replace(/\uFEFF/g, '').split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const lowerCaseHeaders = headers.map(h => h.toLowerCase());

            const brandIndex = lowerCaseHeaders.indexOf('brand');
            const nameIndex = lowerCaseHeaders.indexOf('name');
            const priceIndex = lowerCaseHeaders.indexOf('price');
            const codeIndex = lowerCaseHeaders.indexOf('productcode');
            const imageIndex = lowerCaseHeaders.indexOf('imageurl');
            const idIndex = lowerCaseHeaders.indexOf('id');
            const koliIciAdetIndex = lowerCaseHeaders.findIndex(h => h.includes('koli ici fiyat') || h.includes('koli i̇çi̇ adet') || h.includes('pieces per case'));
            const koliFiyatIndex = lowerCaseHeaders.indexOf('koli fiyat');

            for (let i = 1; i < rows.length; i++) {
                const rowText = rows[i].trim();
                if (!rowText.includes(',')) continue;
                const values = rowText.split(',').map(v => v.trim());
                const brand = values[brandIndex] ? values[brandIndex].trim() : null;

                if (!brand || brand.toLowerCase() === 'brand' || brand === 'Koli Fiyat') continue;
                if (!data[brand]) data[brand] = [];
                if (!seenBrands.has(brand)) { orderedBrands.push(brand); seenBrands.add(brand); }

                let imageUrl = values[imageIndex] || null;
                if (imageUrl && imageUrl.startsWith('https//')) imageUrl = 'https://' + imageUrl.substring(8);
                
                const productData = {
                    id: values[idIndex] || `prod-${Date.now()}-${i}`,
                    productCode: values[codeIndex] || 'N/A',
                    name: values[nameIndex] || 'Unnamed Product',
                    price: parseFloat(values[priceIndex]) || 0,
                    imageUrl: imageUrl,
                    koliIciAdet: parseInt(values[koliIciAdetIndex], 10) || 0,
                    koliFiyat: parseFloat(values[koliFiyatIndex]) || 0
                };
                data[brand].push(productData);
            }
            return data;
        }
        
        /**
         * Renders the product grid for a selected brand.
         * @param {string} brand - The brand name to display.
         * @param {boolean} shouldScroll - Whether to scroll to the top of the section.
         */
        function displayProducts(brand, shouldScroll = true) {
            currentBrand = brand;
            if (!catalogData[brand] || catalogData[brand].length === 0) {
                console.warn(`Brand "${brand}" not found or has no products.`);
                productGrid.innerHTML = `<p class="text-center col-span-full">No products found for this brand.</p>`; return;
            }
            
            const brandLogoUrl = brandLogoMap[brand] || "https://placehold.co/100x100/FFFFFF/CCCCCC?text=Logo";
            brandTitleContainer.innerHTML = `
                <span class="w-3 h-10 brand-title-accent rounded-full"></span>
                <img src="${brandLogoUrl}" alt="${brand} Logo" class="h-10 w-auto object-contain">
                <h2 class="text-3xl font-bold text-slate-800">${brand}</h2>`;
            
            // NEW: Scroll to the brand navigation bar when a new brand is clicked
            if (shouldScroll) {
                brandNavContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            productGrid.innerHTML = '';
            document.querySelectorAll('#brand-nav-buttons button').forEach(button => {
                const isActive = button.dataset.brand === brand;
                button.className = `px-3 py-2 text-sm font-semibold rounded-full transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center gap-2 ${isActive ? 'brand-button-active shadow-lg' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`;
            });

            const products = catalogData[brand] || [];
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = "product-card-animate bg-white rounded-2xl shadow-lg overflow-hidden group transition-shadow duration-300 hover:shadow-xl flex flex-col";
                card.style.animationDelay = `${index * 50}ms`;
                const placeholderUrl = `https://placehold.co/400x400/EEE/31343C?text=${encodeURIComponent(product.name.split(' ')[0])}`;
                const imageUrl = product.imageUrl || placeholderUrl;
                const quantity = cart[product.id]?.quantity || 0;

                let quantityControlsHTML = quantity === 0
                    ? `<button data-product-id="${product.id}" class="add-to-cart-btn btn-primary w-full rounded-lg px-4 py-2 font-semibold transition-all">Add to Cart</button>`
                    : `<div class="flex items-center justify-center gap-2">
                           <button data-product-id="${product.id}" class="decrement-btn bg-slate-200 text-slate-800 rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg hover:bg-slate-300">-</button>
                           <span class="font-bold text-lg w-10 text-center">${quantity}</span>
                           <button data-product-id="${product.id}" class="increment-btn bg-slate-200 text-slate-800 rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg hover:bg-slate-300">+</button>
                       </div>`;
                
                let pricingAndControlsHTML = product.koliFiyat > 0
                    ? `<div class="space-y-4">
                           <div class="flex justify-between items-center">
                               <div>
                                   <p class="text-xl font-extrabold text-slate-900">${product.price.toFixed(2)} TL</p>
                                   <p class="text-sm text-slate-500">/ piece</p>
                               </div>
                               <div class="text-right">
                                   <p class="text-xl font-extrabold price-accent-color">${product.koliFiyat.toFixed(2)} TL</p>
                                   <p class="text-sm text-slate-500">/ Koli Fiyat (${product.koliIciAdet > 0 ? product.koliIciAdet + ' pcs' : ''})</p>
                               </div>
                           </div>
                           <div class="quantity-control-container">${quantityControlsHTML}</div>
                       </div>`
                    : `<div class="space-y-4">
                           <p class="text-xl font-extrabold text-slate-900">${product.price.toFixed(2)} TL <span class="text-sm text-slate-500 font-medium align-baseline">/ piece</span></p>
                           <div class="quantity-control-container">${quantityControlsHTML}</div>
                       </div>`;

                card.innerHTML = `
                    <div class="relative h-56">
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-contain p-4 transition-transform duration-300 group-hover:scale-110" loading="lazy" onError="this.onerror=null; this.src='${placeholderUrl}';"/>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <div class="flex-grow"><h3 class="text-lg font-bold text-slate-800 mb-2">${product.name}</h3></div>
                        <div class="mt-4 pt-4 border-t">${pricingAndControlsHTML}</div>
                    </div>`;
                productGrid.appendChild(card);
            });
            productGrid.querySelectorAll('.add-to-cart-btn, .increment-btn').forEach(btn => {
                btn.onclick = () => { const p = findProductById(btn.dataset.productId); if (p) addToCart(p); };
            });
            productGrid.querySelectorAll('.decrement-btn').forEach(btn => {
                btn.onclick = () => { const p = findProductById(btn.dataset.productId); if (p) decrementFromCart(p); };
            });
        }
        
        function findProductById(productId) {
            for (const b in catalogData) { const p = catalogData[b].find(p => p.id === productId); if (p) return p; } return null;
        }
        function addToCart(product) {
            const { id, name, price, koliFiyat } = product;
            if (cart[id]) { cart[id].quantity++; } else { cart[id] = { name, price, koliFiyat, quantity: 1 }; showToast("Item added to cart!"); }
            saveCartToFirestore();
        }
        function decrementFromCart(product) {
            const { id } = product;
            if (cart[id]) { if (cart[id].quantity > 1) { cart[id].quantity--; } else { delete cart[id]; } saveCartToFirestore(); }
        }
        function updateCartQuantity(productId, newQuantity) {
            if (cart[productId]) { if (newQuantity > 0) { cart[productId].quantity = newQuantity; } else { delete cart[productId]; } saveCartToFirestore(); }
        }
        function updateSubmitButtonState() {
            const companyName = companyNameInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();
            const isCartEmpty = Object.keys(cart).length === 0;
            submitOrderBtn.disabled = !(!isCartEmpty && companyName !== '' && phoneNumber !== '');
        }
        function renderCart() {
            cartItemsContainer.innerHTML = Object.keys(cart).length === 0
                ? `<p class="text-slate-500 text-center mt-8">Your cart is empty.</p>`
                : Object.entries(cart).map(([id, item]) => {
                    const priceToShow = (item.koliFiyat && item.koliFiyat > 0) ? item.koliFiyat : item.price;
                    return `<div class="flex justify-between items-center mb-4">
                                <div class="flex-grow">
                                    <p class="font-semibold">${item.name}</p>
                                    <p class="text-sm text-slate-500">${priceToShow.toFixed(2)} TL</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" min="1" value="${item.quantity}" data-id="${id}" class="quantity-input w-16 border rounded-md p-1 text-center">
                                    <button data-id="${id}" class="remove-item-btn text-red-500 hover:text-red-700 text-2xl">&times;</button>
                                </div>
                            </div>`;
                }).join('');
            
            cartItemsContainer.querySelectorAll('.quantity-input').forEach(i => { i.onchange = (e) => updateCartQuantity(e.target.dataset.id, parseInt(e.target.value, 10)); });
            cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(b => { b.onclick = (e) => updateCartQuantity(e.target.dataset.id, 0); });
            updateCartSummary();
            updateSubmitButtonState();
        }
        function updateCartSummary() {
            const total = Object.values(cart).reduce((s, item) => s + ((item.koliFiyat && item.koliFiyat > 0 ? item.koliFiyat : item.price) * item.quantity), 0);
            const itemCount = Object.values(cart).reduce((s, item) => s + item.quantity, 0);
            cartTotalEl.textContent = `${total.toFixed(2)} TL`;
            cartItemCountEl.textContent = itemCount;
            cartItemCountEl.classList.toggle('hidden', itemCount === 0);
        }
        function showToast(message) {
            toastEl.textContent = message;
            toastEl.classList.remove('opacity-0', 'translate-y-3');
            setTimeout(() => { toastEl.classList.add('opacity-0', 'translate-y-3'); }, 2000);
        }
        function toggleCart() { cartContainer.classList.toggle('cart-hidden'); }
        function handleExportPdf() {
            const companyName = companyNameInput.value.trim();
            const fullPhoneNumber = countryCodeInput.value + phoneNumberInput.value.trim();
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            doc.setFontSize(18); doc.text("Order Summary", 14, 22);
            doc.setFontSize(11); doc.setTextColor(100);
            doc.text(`Company: ${companyName}`, 14, 30); doc.text(`Phone: ${fullPhoneNumber}`, 14, 38); doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 46);
            const headers = [["Product Name", "Quantity", "Unit Price (TL)", "Total (TL)"]];
            const data = Object.values(cart).map(item => { const p = (item.koliFiyat && item.koliFiyat > 0) ? item.koliFiyat : item.price; return [ item.name, item.quantity, p.toFixed(2), (p * item.quantity).toFixed(2) ] });
            doc.autoTable({ startY: 55, head: headers, body: data, theme: 'striped', headStyles: { fillColor: [41, 128, 185] } });
            const finalY = doc.autoTable.previous.finalY;
            const total = Object.values(cart).reduce((s, i) => s + ((i.koliFiyat && i.koliFiyat > 0 ? i.koliFiyat : i.price) * i.quantity), 0);
            doc.setFontSize(14); doc.text(`Grand Total: ${total.toFixed(2)} TL`, 14, finalY + 15);
            doc.save(`order_${companyName.replace(/\s+/g, '_')}.pdf`);
        }
        function handleExportExcel() {
            const companyName = companyNameInput.value.trim();
            const fullPhoneNumber = countryCodeInput.value + phoneNumberInput.value.trim();
            const worksheetData = [ ["Company Name:", companyName], ["Phone Number:", fullPhoneNumber], [], ["Product Name", "Quantity", "Unit Price (TL)", "Total (TL)"] ];
            let total = 0;
            Object.values(cart).forEach(item => { const p = (item.koliFiyat && item.koliFiyat > 0) ? item.koliFiyat : item.price; const iTotal = p * item.quantity; total += iTotal; worksheetData.push([ item.name, item.quantity, p, iTotal ]); });
            worksheetData.push([], ["", "", "Grand Total:", total]);
            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cart");
            XLSX.writeFile(wb, `order_${companyName.replace(/\s+/g, '_')}.xlsx`);
        }
        async function handleSubmitOrder() {
            const companyName = companyNameInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();
            if (!companyName || !phoneNumber) { showToast("Please fill in all required fields."); return; }
            const fullPhoneNumber = countryCodeInput.value + phoneNumber;
            const total = Object.values(cart).reduce((s, i) => s + ((i.koliFiyat && i.koliFiyat > 0 ? i.koliFiyat : i.price) * i.quantity), 0);
            const orderData = { companyName, phoneNumber: fullPhoneNumber, cart, total, currency: 'TL', userId, createdAt: serverTimestamp() };
            try {
                const ordersCollectionRef = collection(db, `/artifacts/${appId}/public/data/orders`);
                await addDoc(ordersCollectionRef, orderData);
                showToast("Order submitted successfully!");
                handleExportPdf(); handleExportExcel();
                cart = {}; await saveCartToFirestore();
                companyNameInput.value = ''; phoneNumberInput.value = '';
            } catch (error) { console.error("Error submitting order:", error); showToast("Failed to submit order."); }
        }
        async function initCatalogApp() {
            await initializeFirebase();
            try {
                const response = await fetch(googleSheetCsvUrl);
                if (!response.ok) throw new Error(`Network response was not ok (status: ${response.status}).`);
                const csvText = await response.text();
                catalogData = parseCsvData(csvText);
                brandNavContainer.innerHTML = '';
                if (orderedBrands.length > 0) {
                    orderedBrands.forEach(brand => {
                        const button = document.createElement('button');
                        button.dataset.brand = brand;
                        button.className = 'px-3 py-2 text-sm font-semibold rounded-full transition-all duration-300 ease-in-out transform hover:scale-105 bg-slate-200 text-slate-700 hover:bg-slate-300 flex items-center gap-2';
                        const logoUrl = brandLogoMap[brand] || "https://placehold.co/100x100/FFFFFF/CCCCCC?text=Logo";
                        button.innerHTML = `<img src="${logoUrl}" alt="${brand} Logo" class="h-6 w-6 object-contain rounded-full bg-white p-0.5"> <span>${brand}</span>`;
                        button.onclick = () => displayProducts(brand);
                        brandNavContainer.appendChild(button);
                    });
                    displayProducts(orderedBrands[0], false); // Don't scroll on initial load
                } else {
                    brandTitleContainer.innerHTML = `<h2 class="text-3xl font-bold text-slate-800">No products found.</h2>`;
                    productGrid.innerHTML = `<p class="text-center col-span-full text-slate-500">The catalog is empty.</p>`;
                }
            } catch (error) {
                console.error('Failed to initialize app:', error);
                brandTitleContainer.innerHTML = `<h2 class="text-3xl font-bold text-red-600">Error Loading Products</h2>`;
                productGrid.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"><p>${error.message}</p></div>`;
            }
        }
        
        // --- Event Listeners ---
        viewCartButton.addEventListener('click', toggleCart);
        closeCartButton.addEventListener('click', toggleCart);
        submitOrderBtn.addEventListener('click', handleSubmitOrder);
        companyNameInput.addEventListener('input', updateSubmitButtonState);
        phoneNumberInput.addEventListener('input', updateSubmitButtonState);
        
        // --- Scroll to Top Logic ---
        window.onscroll = () => {
            if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        };
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.addEventListener('DOMContentLoaded', initCatalogApp);

    </script>
</body>
</html>


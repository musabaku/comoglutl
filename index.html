<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Price Catalog</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- jsPDF and jsPDF-AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Custom Styles & Animations -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }

        /* Animation for product cards appearing */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-card-animate {
            opacity: 0; 
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* bg-slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* bg-slate-400 */
        }

        /* Cart styles */
        #cart-container {
            transition: transform 0.3s ease-in-out;
        }
        .cart-hidden {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- Header Section -->
    <header class="bg-slate-800 shadow-lg sticky top-0 z-20">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <!-- Left Side: Main Logo and Title -->
            <div class="flex items-center gap-4 sm:gap-6">
                <img src="https://i.ibb.co/7d57gNYf/Clean_Shot-14-08-2025-at-2-11-43-2x.png" alt="Company Logo" class="h-12 w-auto" onerror="this.onerror=null; this.src='https://placehold.co/100x48/1e293b/ffffff?text=Logo';">
                <div class="text-left">
                    <h1 class="text-xl md:text-3xl font-extrabold text-white tracking-tight">
                        Digital Price Catalog
                    </h1>
                </div>
            </div>
            
            <!-- Right Side: Text, Partner Logos, and Cart -->
            <div class="flex items-center gap-2 sm:gap-4">
                <p class="text-slate-300 text-xs sm:text-sm text-right">Leading Turkish FMCG Distributors & Exporters</p>
                <img src="https://placehold.co/40x40/ffffff/1e293b?text=L1" alt="Partner Logo 1" class="h-10 w-10 rounded-full object-cover hidden sm:block">
                <img src="https://placehold.co/40x40/ffffff/1e293b?text=L2" alt="Partner Logo 2" class="h-10 w-10 rounded-full object-cover hidden sm:block">
                <button id="view-cart-button" class="relative bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-item-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-8 relative">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Products Section -->
            <div class="w-full">
                <!-- Brand Navigation Buttons -->
                <nav id="brand-nav" class="bg-white p-4 shadow-md mb-10 rounded-xl md:sticky top-24 z-10 backdrop-blur-sm bg-white/70">
                    <div id="brand-nav-buttons" class="flex flex-wrap justify-center gap-3">
                        <div class="text-center p-4">Loading Brands...</div>
                    </div>
                </nav>

                <!-- Product Display Section -->
                <section id="product-section">
                    <div id="brand-title-container" class="flex items-center mb-8 gap-4">
                        <span class="w-3 h-10 bg-indigo-500 rounded-full"></span>
                        <h2 id="brand-title" class="text-3xl font-bold text-slate-800">
                            Loading...
                        </h2>
                    </div>
                    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        <!-- Product cards will be dynamically injected here -->
                    </div>
                </section>
            </div>

            <!-- Shopping Cart Section -->
            <aside id="cart-container" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-50 p-6 flex flex-col cart-hidden">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-slate-800">My Cart</h2>
                    <button id="close-cart-button" class="text-slate-500 hover:text-slate-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="cart-items" class="flex-grow overflow-y-auto">
                    <!-- Cart items will be injected here -->
                    <p class="text-slate-500 text-center mt-8">Your cart is empty.</p>
                </div>
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center font-bold text-lg mb-4">
                        <span>Total:</span>
                        <span id="cart-total">0.00 TL</span>
                    </div>
                    <div class="mb-4">
                        <label for="company-name" class="block text-sm font-medium text-slate-700 mb-1">Company Name *</label>
                        <input type="text" id="company-name" name="company-name" class="w-full border-slate-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your company name" required>
                    </div>
                    <div class="flex gap-2">
                        <button id="export-pdf" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition disabled:opacity-50" disabled>Export PDF</button>
                        <button id="export-excel" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition disabled:opacity-50" disabled>Export Excel</button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="text-center py-6 mt-12 bg-white border-t border-slate-200">
        <p class="text-slate-500 text-sm">&copy; 2025 Çomoğlu Gıda Price Catalog. All rights reserved.</p>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-3 transition-all duration-300">
        Item added to cart!
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const googleSheetCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTemIQAjyMsEqPPUYaNMIn2rwrEbuqR7NrW9vey_mC1iZmIn7FZlOH7g3Co7bZG5B18BJy7Cjldvs53/pub?gid=0&single=true&output=csv';

        const brandLogoMap = {
            "BEŞLER": "https://res.cloudinary.com/dnc3itu1c/image/upload/l1.jpg",
            "MASSIMO": "https://res.cloudinary.com/dnc3itu1c/image/upload/l2.jpg",
            "EDAY": "https://res.cloudinary.com/dnc3itu1c/image/upload/l3.jpg",
            "BENORGANIC": "https://res.cloudinary.com/dnc3itu1c/image/upload/l4.jpg",
            "UĞURLU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l5.jpg",
            "ÜNALPEYNIR": "https://res.cloudinary.com/dnc3itu1c/image/upload/l6.jpg",
            "ŞİFALIKÖY": "https://res.cloudinary.com/dnc3itu1c/image/upload/l7.jpg",
            "HOSANLI": "https://res.cloudinary.com/dnc3itu1c/image/upload/v1755239661/l8.jpg",
            "ORDU TARIM": "https://res.cloudinary.com/dnc3itu1c/image/upload/v1755239712/l9.jpg",
            "HAŞİROĞLU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l10.jpg",
            "TADA": "https://res.cloudinary.com/dnc3itu1c/image/upload/l11.jpg",
            "TAT": "https://res.cloudinary.com/dnc3itu1c/image/upload/l12.jpg",
            "TEK LEZET": "https://res.cloudinary.com/dnc3itu1c/image/upload/l13.jpg",
            "TAHSİLDAROĞLU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l14.jpg",
            "ERİŞ UN": "https://res.cloudinary.com/dnc3itu1c/image/upload/l15.jpg",
            "SOSERO": "https://res.cloudinary.com/dnc3itu1c/image/upload/l16.jpg",
            "YÖRE": "https://res.cloudinary.com/dnc3itu1c/image/upload/l17.jpg",
            "JUNGLE": "https://res.cloudinary.com/dnc3itu1c/image/upload/l18.jpg",
            "SMILE": "https://res.cloudinary.com/dnc3itu1c/image/upload/l19.jpg",
            "AYTAÇ": "https://res.cloudinary.com/dnc3itu1c/image/upload/l20.jpg",
            "OFÇAY": "https://res.cloudinary.com/dnc3itu1c/image/upload/l21.jpg",
            "EFOR": "https://res.cloudinary.com/dnc3itu1c/image/upload/l22.jpg",
            "GÜNDOĞDU": "https://res.cloudinary.com/dnc3itu1c/image/upload/l23.jpg"
        };

        // --- DOM Elements ---
        const brandNavContainer = document.getElementById('brand-nav-buttons');
        const brandTitleContainer = document.getElementById('brand-title-container');
        const productGrid = document.getElementById('product-grid');
        const cartContainer = document.getElementById('cart-container');
        const viewCartButton = document.getElementById('view-cart-button');
        const closeCartButton = document.getElementById('close-cart-button');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartItemCountEl = document.getElementById('cart-item-count');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportExcelBtn = document.getElementById('export-excel');
        const toastEl = document.getElementById('toast');
        const companyNameInput = document.getElementById('company-name');

        let catalogData = {};
        let orderedBrands = [];
        let cart = {}; // Local cart state
        let currentBrand = null; // To track the currently displayed brand
        
        // --- Firebase ---
        let db, auth, userId;
        let cartDocRef;
        let unsubscribeCart; // To detach listener on sign-out

        // Hardcoded Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjl2QFyRWoN_SjbRKTuhxp9ksgm-5MBTw",
            authDomain: "comogluimg.firebaseapp.com",
            projectId: "comogluimg",
            storageBucket: "comogluimg.appspot.com",
            messagingSenderId: "964383861519",
            appId: "1:964383861519:web:447d607e3c158df951ec7a",
            measurementId: "G-NK80JQBKXE"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-price-catalog';


        /**
         * Initializes Firebase and sets up authentication.
         */
        async function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is not available. Please update it with your actual Firebase project credentials.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                // onAuthStateChanged is the recommended way to manage user sessions.
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        const cartPath = `/artifacts/${appId}/users/${userId}/cart/data`;
                        cartDocRef = doc(db, cartPath);
                        listenToCartChanges();
                    } else {
                        // User is not signed in. Attempt to sign in anonymously.
                        console.log("No user found, attempting anonymous sign-in...");
                        try {
                            await signInAnonymously(auth);
                        } catch (signInError) {
                            console.error("Firebase anonymous sign-in failed:", signInError);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }
        
        /**
         * Listens for real-time updates to the user's cart in Firestore.
         */
        function listenToCartChanges() {
            if (unsubscribeCart) unsubscribeCart();
            if (!cartDocRef) return;

            unsubscribeCart = onSnapshot(cartDocRef, (doc) => {
                cart = doc.exists() ? doc.data().items || {} : {};
                renderCart();
                // Refresh the product grid if a brand is currently displayed
                if (currentBrand) {
                    displayProducts(currentBrand);
                }
            }, (error) => {
                console.error("Error listening to cart changes:", error);
            });
        }

        /**
         * Saves the entire cart object to Firestore.
         */
        async function saveCartToFirestore() {
            if (!cartDocRef) return;
            try {
                await setDoc(cartDocRef, { items: cart });
            } catch (error) {
                console.error("Error saving cart to Firestore:", error);
            }
        }
        
        /**
         * Parses CSV text into a structured JavaScript object.
         */
        function parseCsvData(csvText) {
            const data = {};
            const seenBrands = new Set();
            const rows = csvText.trim().replace(/\r/g, '').split('\n').filter(row => row.trim() !== '');
            
            const headers = rows[0].replace(/\uFEFF/g, '').split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            console.log("DEBUG: Headers found in CSV ->", headers);

            const brandIndex = headers.indexOf('Brand');
            const nameIndex = headers.indexOf('Name');
            const priceIndex = headers.indexOf('Price');
            const codeIndex = headers.indexOf('ProductCode');
            const imageIndex = headers.indexOf('ImageURL');
            const idIndex = headers.indexOf('ID');
            // **FIX**: Look for the new column name "Koli Ici Fiyat" and fall back to the old one.
            const koliIciAdetIndex = headers.indexOf('Koli Ici Fiyat') > -1 ? headers.indexOf('Koli Ici Fiyat') : headers.indexOf('KOLİ İÇİ ADET');
            const koliFiyatIndex = headers.indexOf('Koli Fiyat');
            
            console.log(`DEBUG: Index for 'Pieces per Case' column is ${koliIciAdetIndex}`);
            console.log(`DEBUG: Index for 'Koli Fiyat' is ${koliFiyatIndex}`);

            if (koliIciAdetIndex === -1) {
                console.error("FATAL ERROR: Could not find 'Koli Ici Fiyat' or 'KOLİ İÇİ ADET' header.");
            }
             if (koliFiyatIndex === -1) {
                console.error("FATAL ERROR: Could not find 'Koli Fiyat' header.");
            }

            for (let i = 1; i < rows.length; i++) {
                const rowText = rows[i].trim();
                if (!rowText.includes(',')) continue;
                
                const values = rowText.split(',').map(v => v.trim());
                const brand = values[brandIndex] ? values[brandIndex].trim() : null;

                if (!brand || brand.toLowerCase() === 'brand' || brand === 'Koli Fiyat') {
                    continue;
                }

                if (!data[brand]) {
                    data[brand] = [];
                }
                
                if (!seenBrands.has(brand)) {
                    orderedBrands.push(brand);
                    seenBrands.add(brand);
                }

                let imageUrl = values[imageIndex] || null;
                if (imageUrl && imageUrl.startsWith('https//')) {
                    imageUrl = 'https://' + imageUrl.substring(8);
                }
                
                const productData = {
                    id: values[idIndex] || `prod-${Date.now()}-${i}`,
                    productCode: values[codeIndex] || 'N/A',
                    name: values[nameIndex] || 'Unnamed Product',
                    price: parseFloat(values[priceIndex]) || 0,
                    imageUrl: imageUrl,
                    koliIciAdet: parseInt(values[koliIciAdetIndex], 10) || 0,
                    koliFiyat: parseFloat(values[koliFiyatIndex]) || 0
                };
                
                data[brand].push(productData);
            }
            return data;
        }
        
        /**
         * Renders the product grid for a selected brand.
         */
        function displayProducts(brand) {
            currentBrand = brand; // Set the current brand
            if (!catalogData[brand] || catalogData[brand].length === 0) {
                console.warn(`Brand "${brand}" not found or has no products.`);
                productGrid.innerHTML = `<p class="text-center col-span-full">No products found for this brand.</p>`;
                return;
            }
            
            const brandLogoUrl = brandLogoMap[brand] || "https://placehold.co/100x100/FFFFFF/CCCCCC?text=Logo";

            brandTitleContainer.innerHTML = `
                <span class="w-3 h-10 bg-indigo-500 rounded-full"></span>
                <img src="${brandLogoUrl}" alt="${brand} Logo" class="h-10 w-auto object-contain">
                <h2 class="text-3xl font-bold text-slate-800">${brand}</h2>
            `;
            
            productGrid.innerHTML = '';

            document.querySelectorAll('#brand-nav-buttons button').forEach(button => {
                const isActive = button.dataset.brand === brand;
                button.className = `px-3 py-2 text-sm font-semibold rounded-full transition-all duration-300 ease-in-out transform hover:scale-105 flex items-center gap-2 ${
                    isActive
                        ? 'bg-indigo-600 text-white shadow-lg'
                        : 'bg-slate-200 text-slate-700 hover:bg-slate-300'
                }`;
            });

            const products = catalogData[brand] || [];
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = "product-card-animate bg-white rounded-2xl shadow-lg overflow-hidden group transition-shadow duration-300 hover:shadow-xl flex flex-col";
                card.style.animationDelay = `${index * 50}ms`;

                const placeholderUrl = `https://placehold.co/400x400/EEE/31343C?text=${encodeURIComponent(product.name.split(' ')[0])}`;
                const imageUrl = product.imageUrl || placeholderUrl;
                const quantity = cart[product.id]?.quantity || 0;

                let quantityControlsHTML;
                if (quantity === 0) {
                    quantityControlsHTML = `<button data-product-id="${product.id}" class="add-to-cart-btn w-full bg-indigo-500 text-white rounded-lg px-4 py-2 font-semibold hover:bg-indigo-600 transition-all">Add to Cart</button>`;
                } else {
                    quantityControlsHTML = `
                        <div class="flex items-center justify-center gap-2">
                            <button data-product-id="${product.id}" class="decrement-btn bg-slate-200 text-slate-800 rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg hover:bg-slate-300">-</button>
                            <span class="font-bold text-lg w-10 text-center">${quantity}</span>
                            <button data-product-id="${product.id}" class="increment-btn bg-slate-200 text-slate-800 rounded-full w-8 h-8 flex items-center justify-center font-bold text-lg hover:bg-slate-300">+</button>
                        </div>
                    `;
                }

                // **NEW VISUAL DESIGN FOR THE CARD**
                card.innerHTML = `
                    <div class="relative h-56">
                        <img 
                            src="${imageUrl}" 
                            alt="${product.name}" 
                            class="w-full h-full object-contain p-4 transition-transform duration-300 group-hover:scale-110"
                            loading="lazy"
                            onError="this.onerror=null; this.src='${placeholderUrl}';"
                        />
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-slate-800 mb-2">${product.name}</h3>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t space-y-4">
                            <!-- Pricing Block -->
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-xl font-extrabold text-slate-900">${product.price.toFixed(2)} TL</p>
                                    <p class="text-sm text-slate-500">/ piece</p>
                                </div>
                                ${product.koliFiyat > 0 ? `
                                <div class="text-right">
                                    <p class="text-xl font-extrabold text-indigo-600">${product.koliFiyat.toFixed(2)} TL</p>
                                    <p class="text-sm text-slate-500">/ Koli Fiyat (${product.koliIciAdet} pcs)</p>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Controls -->
                            <div class="quantity-control-container">
                                ${quantityControlsHTML}
                            </div>
                        </div>
                    </div>
                `;
                productGrid.appendChild(card);
            });

            // Add event listeners to the new buttons
            productGrid.querySelectorAll('.add-to-cart-btn, .increment-btn').forEach(btn => {
                btn.onclick = () => {
                    const product = findProductById(btn.dataset.productId);
                    if (product) addToCart(product);
                };
            });
            productGrid.querySelectorAll('.decrement-btn').forEach(btn => {
                btn.onclick = () => {
                    const product = findProductById(btn.dataset.productId);
                    if (product) decrementFromCart(product);
                };
            });
        }
        
        /**
         * Finds a product in the catalogData by its ID.
         */
        function findProductById(productId) {
            for (const brand in catalogData) {
                const product = catalogData[brand].find(p => p.id === productId);
                if (product) return product;
            }
            return null;
        }

        /**
         * Adds a product to the cart or increments its quantity.
         */
        function addToCart(product) {
            const { id, name, price } = product;
            if (cart[id]) {
                cart[id].quantity++;
            } else {
                cart[id] = { name, price, quantity: 1 };
                showToast();
            }
            saveCartToFirestore();
        }
        
        /**
         * Decrements a product's quantity or removes it from the cart.
         */
        function decrementFromCart(product) {
            const { id } = product;
            if (cart[id]) {
                if (cart[id].quantity > 1) {
                    cart[id].quantity--;
                } else {
                    delete cart[id];
                }
                saveCartToFirestore();
            }
        }

        /**
         * Updates item quantity in the cart from the cart sidebar.
         */
        function updateCartQuantity(productId, newQuantity) {
            if (cart[productId]) {
                if (newQuantity > 0) {
                    cart[productId].quantity = newQuantity;
                } else {
                    delete cart[productId];
                }
                saveCartToFirestore();
            }
        }

        /**
         * Checks if export buttons should be enabled or disabled.
         */
        function updateExportButtonState() {
            const companyName = companyNameInput.value.trim();
            const isCartEmpty = Object.keys(cart).length === 0;
            const canExport = !isCartEmpty && companyName !== '';

            exportPdfBtn.disabled = !canExport;
            exportExcelBtn.disabled = !canExport;
        }

        /**
         * Renders the cart UI based on the local cart state.
         */
        function renderCart() {
            if (Object.keys(cart).length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-slate-500 text-center mt-8">Your cart is empty.</p>`;
            } else {
                cartItemsContainer.innerHTML = '';
                Object.entries(cart).forEach(([id, item]) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center mb-4';
                    itemEl.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-slate-500">${item.price.toFixed(2)} TL</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" min="1" value="${item.quantity}" data-id="${id}" class="quantity-input w-16 border rounded-md p-1 text-center">
                            <button data-id="${id}" class="remove-item-btn text-red-500 hover:text-red-700 text-2xl">&times;</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                });
            }

            // Add event listeners for quantity changes and removal
            cartItemsContainer.querySelectorAll('.quantity-input').forEach(input => {
                input.onchange = (e) => {
                    const newQuantity = parseInt(e.target.value, 10);
                    updateCartQuantity(e.target.dataset.id, newQuantity);
                };
            });
            cartItemsContainer.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.onclick = (e) => updateCartQuantity(e.target.dataset.id, 0);
            });

            updateCartSummary();
            updateExportButtonState();
        }

        /**
         * Updates the cart total and item count bubble.
         */
        function updateCartSummary() {
            const total = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemCount = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            
            cartTotalEl.textContent = `${total.toFixed(2)} TL`;
            cartItemCountEl.textContent = itemCount;
            cartItemCountEl.classList.toggle('hidden', itemCount === 0);
        }

        /**
         * Shows a short-lived toast notification.
         */
        function showToast() {
            toastEl.classList.remove('opacity-0', 'translate-y-3');
            setTimeout(() => {
                toastEl.classList.add('opacity-0', 'translate-y-3');
            }, 2000);
        }
        
        /**
         * Toggles the visibility of the cart sidebar.
         */
        function toggleCart() {
            cartContainer.classList.toggle('cart-hidden');
        }

        /**
         * Exports the cart to a PDF file.
         */
        function handleExportPdf() {
            const companyName = companyNameInput.value.trim();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text("Order Summary", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Company: ${companyName}`, 14, 30);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 38);

            const headers = [["Product Name", "Quantity", "Unit Price (TL)", "Total (TL)"]];
            const data = Object.values(cart).map(item => [
                item.name,
                item.quantity,
                item.price.toFixed(2),
                (item.price * item.quantity).toFixed(2)
            ]);

            doc.autoTable({
                startY: 50,
                head: headers,
                body: data,
                theme: 'striped',
                headStyles: { fillColor: [41, 128, 185] }
            });

            const finalY = doc.autoTable.previous.finalY;
            const total = Object.values(cart).reduce((sum, item) => sum + item.price * item.quantity, 0);
            doc.setFontSize(14);
            doc.text(`Grand Total: ${total.toFixed(2)} TL`, 14, finalY + 15);

            doc.save(`order_${companyName.replace(/\s+/g, '_')}.pdf`);
        }

        /**
         * Exports the cart to an Excel (XLSX) file.
         */
        function handleExportExcel() {
            const companyName = companyNameInput.value.trim();
            const worksheetData = [
                ["Company Name:", companyName],
                [], // Spacer row
                ["Product Name", "Quantity", "Unit Price (TL)", "Total (TL)"]
            ];
            
            let total = 0;
            Object.values(cart).forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                worksheetData.push([
                    item.name,
                    item.quantity,
                    item.price,
                    itemTotal
                ]);
            });
            
            worksheetData.push([]); // Spacer row
            worksheetData.push(["", "", "Grand Total:", total]);

            const ws = XLSX.utils.aoa_to_sheet(worksheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Cart");
            XLSX.writeFile(wb, `order_${companyName.replace(/\s+/g, '_')}.xlsx`);
        }

        /**
         * Initializes the application.
         */
        async function initCatalogApp() {
            await initializeFirebase();
            try {
                const response = await fetch(googleSheetCsvUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok (status: ${response.status}). Check if the sheet is published correctly.`);
                }
                const csvText = await response.text();
                catalogData = parseCsvData(csvText);
                
                brandNavContainer.innerHTML = '';
                if (orderedBrands.length > 0) {
                    orderedBrands.forEach(brand => {
                        const button = document.createElement('button');
                        button.dataset.brand = brand;
                        button.className = 'px-3 py-2 text-sm font-semibold rounded-full transition-all duration-300 ease-in-out transform hover:scale-105 bg-slate-200 text-slate-700 hover:bg-slate-300 flex items-center gap-2';
                        
                        const logoUrl = brandLogoMap[brand] || "https://placehold.co/100x100/FFFFFF/CCCCCC?text=Logo";

                        button.innerHTML = `
                            <img src="${logoUrl}" alt="${brand} Logo" class="h-6 w-6 object-contain rounded-full bg-white p-0.5">
                            <span>${brand}</span>
                        `;

                        button.onclick = () => {
                            displayProducts(brand);
                        };
                        brandNavContainer.appendChild(button);
                    });
                    displayProducts(orderedBrands[0]);
                } else {
                    brandTitleContainer.innerHTML = `<h2 class="text-3xl font-bold text-slate-800">No products found.</h2>`;
                    productGrid.innerHTML = `<p class="text-center col-span-full text-slate-500">The catalog is currently empty. Please add products to the Google Sheet.</p>`;
                }

            } catch (error) {
                console.error('Failed to initialize app:', error);
                brandTitleContainer.innerHTML = `<h2 class="text-3xl font-bold text-red-600">Error Loading Products</h2>`;
                productGrid.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 col-span-full rounded-r-lg" role="alert">
                                                 <p class="font-bold">Failed to load data</p>
                                                 <p>${error.message}</p>
                                               </div>`;
            }
        }
        
        // --- Event Listeners ---
        viewCartButton.addEventListener('click', toggleCart);
        closeCartButton.addEventListener('click', toggleCart);
        exportPdfBtn.addEventListener('click', handleExportPdf);
        exportExcelBtn.addEventListener('click', handleExportExcel);
        companyNameInput.addEventListener('input', updateExportButtonState);
        document.addEventListener('DOMContentLoaded', initCatalogApp);

    </script>
</body>
</html>
